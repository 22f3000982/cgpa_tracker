<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - CGPA Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: all 0.3s ease;
        }
        
        body.dark-mode {
            background: #1a1a1a;
            color: #ecf0f1;
        }
        
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .dark-mode .navbar {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .navbar-brand {
            font-weight: 600;
            color: white !important;
        }
        
        .navbar-text {
            color: rgba(255, 255, 255, 0.9) !important;
        }
        
        .dark-mode-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 8px;
            padding: 8px 12px;
            margin-right: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .dark-mode-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }
        
        .main-content {
            padding: 20px 0;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .dark-mode .stat-card {
            background: #2c3e50;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            color: #ecf0f1;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .cgpa-card .stat-value {
            color: #28a745;
        }
        
        .credits-card .stat-value {
            color: #667eea;
        }
        
        .courses-card .stat-value {
            color: #fd7e14;
        }
        
        .progress-card .stat-value {
            color: #6f42c1;
        }
        
        .course-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .dark-mode .course-section {
            background: #2c3e50;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            color: #ecf0f1;
        }
        
        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
            transition: border-color 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-credits {
            font-size: 0.85rem;
            font-weight: 500;
            color: #6c757d;
            background: rgba(102, 126, 234, 0.1);
            padding: 3px 10px;
            border-radius: 20px;
        }
        
        .dark-mode .section-credits {
            background: rgba(52, 152, 219, 0.2);
            color: #bdc3c7;
        }
        
        .dark-mode .section-title {
            border-bottom-color: #34495e;
            color: #ecf0f1;
        }
        
        .course-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .dark-mode .course-card {
            background: #2c3e50;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }
        
        .course-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }
        
        .course-code {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .dark-mode .course-code {
            color: #3498db;
        }
        
        .course-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 12px;
            min-height: 40px;
        }
        
        .credits-display {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .dark-mode .credits-display {
            color: #bdc3c7;
        }
        
        .grade-buttons {
            display: flex;
            justify-content: space-between;
            gap: 5px;
        }
        
        .grade-btn {
            flex: 1;
            background: #f1f3f5;
            border: 1px solid #dee2e6;
            color: #495057;
            font-weight: 600;
            padding: 6px 0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .dark-mode .grade-btn {
            background: #34495e;
            border-color: #2c3e50;
            color: #ecf0f1;
        }
        
        .grade-btn:hover {
            background: #e9ecef;
        }
        
        .dark-mode .grade-btn:hover {
            background: #2c3e50;
        }
        
        .grade-btn.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }
        
        .dark-mode .grade-btn.active {
            background: #3498db;
            border-color: #2980b9;
        }
        
        /* Status header styling */
        .header-info {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 25px;
        }
        
        .dark-mode .header-info {
            background: rgba(52, 152, 219, 0.1);
        }
        
        .header-stats {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header-stat-item {
            flex: 1;
            min-width: 120px;
            text-align: center;
        }
        
        .header-stat-value {
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .header-cgpa {
            color: #28a745;
        }
        
        .dark-mode .header-cgpa {
            color: #2ecc71;
        }
        
        .header-credits {
            color: #667eea;
        }
        
        .dark-mode .header-credits {
            color: #3498db;
        }
        
        .header-stat-label {
            font-size: 0.85rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .dark-mode .header-stat-label {
            color: #bdc3c7;
        }
        
        .dark-mode .course-item {
            background: #34495e;
            border-left-color: #3498db;
        }
        
        .course-info {
            flex: 1;
        }
        
        .course-name {
            font-weight: 500;
            margin-bottom: 2px;
            transition: color 0.3s ease;
        }
        
        .dark-mode .course-name {
            color: #ecf0f1;
        }
        
        .course-id {
            font-size: 0.8rem;
            color: #6c757d;
            transition: color 0.3s ease;
        }
        
        .dark-mode .course-id {
            color: #95a5a6;
        }
        
        .course-credits {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-right: 10px;
            transition: background 0.3s ease;
        }
        
        .dark-mode .course-credits {
            background: #3498db;
        }
        
        .grade-select {
            border-radius: 8px;
            border: 2px solid #e1e5e9;
            padding: 8px 12px;
            min-width: 80px;
            background: white;
            transition: all 0.3s ease;
        }
        
        .grade-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .dark-mode .grade-select {
            background: #2c3e50;
            border-color: #34495e;
            color: #ecf0f1;
        }
        
        .dark-mode .grade-select:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: none;
            border: 2px solid #667eea;
            border-radius: 50px;
            padding: 8px 16px;
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
            font-size: 0.9rem;
        }
        
        .dark-mode .dark-mode-toggle {
            border-color: #3498db;
            color: #3498db;
        }
        
        .dark-mode-toggle:hover {
            background: #667eea;
            color: white;
        }
        
        .dark-mode .dark-mode-toggle:hover {
            background: #3498db;
            color: white;
        }
        
        .dark-mode .btn-logout {
            background: rgba(52, 152, 219, 0.2);
            border-color: rgba(52, 152, 219, 0.3);
            color: #3498db;
        }
        
        .dark-mode .btn-logout:hover {
            background: rgba(52, 152, 219, 0.3);
            color: #3498db;
        }
        
        .dark-mode .btn-save {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }
        
        .dark-mode .btn-save:hover {
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }
        
        .dark-mode .loading {
            color: #95a5a6;
        }
        
        .dark-mode .spinner-border {
            color: #3498db !important;
        }
        
        .grade-S { background-color: #28a745; color: white; }
        .grade-A { background-color: #17a2b8; color: white; }
        .grade-B { background-color: #007bff; color: white; }
        .grade-C { background-color: #ffc107; color: black; }
        .grade-D { background-color: #fd7e14; color: white; }
        .grade-E { background-color: #dc3545; color: white; }
        
        .btn-logout {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 8px;
            padding: 8px 16px;
            transition: all 0.3s ease;
        }
        
        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }
        
        .btn-save {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }
        
        .spinner-border {
            margin-bottom: 15px;
        }
        
        .option-card {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .option-card:hover {
            border-color: #667eea;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.1);
        }
        
        .option-card.selected {
            border-color: #667eea;
            background: #f8f9ff;
            box-shadow: 0 3px 15px rgba(102, 126, 234, 0.2);
        }
        
        .dark-mode .option-card {
            background: #34495e;
            border-color: #2c3e50;
            color: #ecf0f1;
        }
        
        .dark-mode .option-card:hover {
            border-color: #3498db;
            box-shadow: 0 3px 10px rgba(52, 152, 219, 0.2);
        }
        
        .dark-mode .option-card.selected {
            border-color: #3498db;
            background: #2c3e50;
            box-shadow: 0 3px 15px rgba(52, 152, 219, 0.3);
        }
        
        .option-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .option-header input[type="radio"] {
            margin-right: 10px;
        }
        
        .option-description {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        
        .dark-mode .option-description {
            color: #95a5a6;
        }
        
        .option-courses {
            display: none;
        }
        
        .option-card.selected .option-courses {
            display: block;
        }
    </style>
</head>
<body>
    <button class="dark-mode-toggle" onclick="toggleDarkMode()">
        <i class="fas fa-moon" id="theme-icon"></i>
        <span id="theme-text">Dark</span>
    </button>
    
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-graduation-cap me-2"></i>
                CGPA Tracker
            </a>
            <div class="navbar-nav ms-auto d-flex flex-row align-items-center">
                <span class="navbar-text me-3">
                    Welcome, <span id="username">Loading...</span>
                </span>
                <button class="btn btn-logout me-2" onclick="goToAdmin()" id="admin-btn" style="display: none;">
                    <i class="fas fa-user-shield me-1"></i>
                    Admin
                </button>
                <button class="btn btn-logout" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-1"></i>
                    Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="container main-content">
        <div id="loading" class="loading">
            <div class="spinner-border text-primary" role="status"></div>
            <div>Loading your data...</div>
        </div>
        
        <div id="dashboard-content" style="display: none;">
            <!-- Status Header -->
            <div class="header-info mb-4">
                <div class="header-stats">
                    <div class="header-stat-item">
                        <div class="header-stat-value header-cgpa" id="current-cgpa">0.00</div>
                        <div class="header-stat-label">Current CGPA</div>
                    </div>
                    <div class="header-stat-item">
                        <div class="header-stat-value header-credits" id="total-credits">0</div>
                        <div class="header-stat-label">Total Credits</div>
                    </div>
                    <div class="header-stat-item">
                        <div class="header-stat-value" id="completed-courses">0</div>
                        <div class="header-stat-label">Courses Completed</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card progress-card">
                        <div class="stat-value" id="progress-percentage">0%</div>
                        <div class="stat-label">Degree Progress</div>
                    </div>
                </div>
            </div>

            <!-- Course Sections -->
            <div class="row">
                <div class="col-12">
                    <!-- Foundation Level -->
                    <div id="foundation-section" class="course-section">
                        <h5 class="section-title">
                            <i class="fas fa-building-columns me-2"></i>
                            Foundation Level
                            <span class="section-credits">0/32 credits</span>
                        </h5>
                        <div id="foundation-courses"></div>
                    </div>

                    <!-- Programming Diploma -->
                    <div id="programming-section" class="course-section">
                        <h5 class="section-title">
                            <i class="fas fa-code me-2"></i>
                            Diploma in Programming
                            <span class="section-credits">0/27 credits</span>
                        </h5>
                        <div id="programming-courses"></div>
                    </div>

                    <!-- Data Science Diploma -->
                    <div id="datascience-section" class="course-section">
                        <h5 class="section-title">
                            <i class="fas fa-chart-line me-2"></i>
                            Diploma in Data Science
                            <span class="section-credits">0/28 credits</span>
                        </h5>
                        
                        <!-- Core Courses -->
                        <div class="mb-4">
                            <h6 class="text-muted mb-3">Core Courses</h6>
                            <div id="dataScience-core-courses"></div>
                        </div>
                        
                        <!-- Option Selection -->
                        <div class="mb-4">
                            <h6 class="text-muted mb-3">Select One Option:</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="option-card" id="option1-card" onclick="selectDataScienceOption('option1')">
                                        <div class="option-header">
                                            <input type="radio" name="dataScience-option" value="option1" id="option1-radio">
                                            <label for="option1-radio" class="fw-bold">Option 1: Business Analytics</label>
                                        </div>
                                        <div class="option-description">Business Analytics + Business Data Management Project</div>
                                        <div id="dataScience-option1-courses" class="option-courses mt-3"></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="option-card" id="option2-card" onclick="selectDataScienceOption('option2')">
                                        <div class="option-header">
                                            <input type="radio" name="dataScience-option" value="option2" id="option2-radio">
                                            <label for="option2-radio" class="fw-bold">Option 2: Generative AI</label>
                                        </div>
                                        <div class="option-description">Introduction to Deep Learning and Generative AI + Project</div>
                                        <div id="dataScience-option2-courses" class="option-courses mt-3"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div class="text-center mt-4">
                        <button class="btn btn-save" onclick="saveData()">
                            <i class="fas fa-sync-alt me-2"></i>
                            Manual Sync
                        </button>
                        <div class="mt-2 text-muted small">
                            <i class="fas fa-magic me-1"></i>
                            Grades are automatically saved when you select them
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = window.location.origin + '/api';
        let userData = {};
        let courseData = {};
        let allCourses = {};
        let courseGroups = {};
        let courseOptions = {};
        let selectedDataScienceOption = null;

        // Check authentication
        function checkAuth() {
            const token = localStorage.getItem('access_token');
            console.log('DEBUG: Token from localStorage:', token ? 'Token exists' : 'No token found');
            if (!token) {
                console.log('DEBUG: No token found, redirecting to login');
                window.location.href = '/';
                return false;
            }
            return token;
        }

        // Logout function
        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('user');
            window.location.href = '/';
        }

        // Go to admin dashboard
        function goToAdmin() {
            window.location.href = '/admin';
        }

        // Load user data
        async function loadUserData() {
            const token = checkAuth();
            if (!token) return;

            try {
                // Load user info
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                document.getElementById('username').textContent = user.username || 'User';
                
                // Show admin button if user is admin
                if (user.is_admin) {
                    document.getElementById('admin-btn').style.display = 'block';
                }

                // Load courses
                const coursesResponse = await fetch(`${API_BASE}/courses`);
                const coursesData = await coursesResponse.json();
                
                // Store course groups and options
                courseGroups = coursesData.courses;
                courseOptions = coursesData.options;
                
                // Flatten courses for backward compatibility
                Object.values(coursesData.courses).forEach(group => {
                    if (Array.isArray(group)) {
                        group.forEach(course => {
                            allCourses[course.id] = course;
                        });
                    }
                });

                // Load user data
                const response = await fetch(`${API_BASE}/user/data`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('DEBUG: Response status:', response.status);
                
                if (!response.ok) {
                    if (response.status === 401 || response.status === 422) {
                        console.log('DEBUG: Authentication failed, clearing token and redirecting');
                        localStorage.removeItem('access_token');
                        localStorage.removeItem('user');
                        window.location.href = '/';
                        return;
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('DEBUG: User data loaded successfully');
                userData = data;
                courseData = data.course_data || { courses: {} };

                updateDashboard();
                renderCourses();

            } catch (error) {
                console.error('Error loading data:', error);
                alert('Failed to load data. Please refresh the page.');
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
            }
        }

        // Update dashboard statistics
        function updateDashboard() {
            const stats = userData.stats || {
                cgpa: 0,
                totalCredits: 0,
                completedCourses: 0,
                gradeDistribution: { S: 0, A: 0, B: 0, C: 0, D: 0, E: 0 }
            };

            document.getElementById('current-cgpa').textContent = stats.cgpa.toFixed(2);
            document.getElementById('total-credits').textContent = stats.totalCredits;
            document.getElementById('completed-courses').textContent = stats.completedCourses;
            
            // Calculate progress (assuming 142 total credits for degree)
            const progressPercentage = Math.min((stats.totalCredits / 142) * 100, 100);
            document.getElementById('progress-percentage').textContent = progressPercentage.toFixed(1) + '%';
            
            // Update section credits
            updateSectionCredits();
        }
        
        // Update the credits counter for each section
        function updateSectionCredits() {
            // Define total credits for each section
            const sectionTotalCredits = {
                foundation: 32,
                programming: 27,
                dataScience: 28
            };
            
            // Calculate completed credits for each section
            const sectionCompletedCredits = {
                foundation: 0,
                programming: 0,
                dataScience: 0
            };
            
            // Count foundation credits
            const foundationCourses = courseGroups.foundation || [];
            foundationCourses.forEach(course => {
                if (courseData.courses[course.id]?.grade) {
                    sectionCompletedCredits.foundation += course.credits;
                }
            });
            
            // Count programming credits
            const programmingCourses = courseGroups.programming || [];
            programmingCourses.forEach(course => {
                if (courseData.courses[course.id]?.grade) {
                    sectionCompletedCredits.programming += course.credits;
                }
            });
            
            // Count data science credits (core + selected option)
            const dataScienceCoreCourses = courseGroups.dataScience_core || [];
            dataScienceCoreCourses.forEach(course => {
                if (courseData.courses[course.id]?.grade) {
                    sectionCompletedCredits.dataScience += course.credits;
                }
            });
            
            // Add credits from selected option
            const optionKey = selectedDataScienceOption === 'option1' ? 'dataScience_option1' : 'dataScience_option2';
            const optionCourses = courseGroups[optionKey] || [];
            optionCourses.forEach(course => {
                if (courseData.courses[course.id]?.grade) {
                    sectionCompletedCredits.dataScience += course.credits;
                }
            });
            
            // Update the section credit displays - using safer selector approach
            const foundationCreditsElement = document.querySelector('#foundation-section .section-credits');
            if (foundationCreditsElement) {
                foundationCreditsElement.textContent = 
                    `${sectionCompletedCredits.foundation}/${sectionTotalCredits.foundation} credits`;
            }
                
            const programmingCreditsElement = document.querySelector('#programming-section .section-credits');
            if (programmingCreditsElement) {
                programmingCreditsElement.textContent = 
                    `${sectionCompletedCredits.programming}/${sectionTotalCredits.programming} credits`;
            }
                
            const dataScienceCreditsElement = document.querySelector('#datascience-section .section-credits');
            if (dataScienceCreditsElement) {
                dataScienceCreditsElement.textContent = 
                    `${sectionCompletedCredits.dataScience}/${sectionTotalCredits.dataScience} credits`;
            }
        }

        // Render courses
        function renderCourses() {
            // Render Foundation courses
            renderCourseSection('foundation', 'foundation-courses');
            
            // Render Programming courses
            renderCourseSection('programming', 'programming-courses');
            
            // Render Data Science core courses
            renderCourseSection('dataScience_core', 'dataScience-core-courses');
            
            // Render Data Science option courses
            renderCourseSection('dataScience_option1', 'dataScience-option1-courses');
            renderCourseSection('dataScience_option2', 'dataScience-option2-courses');
            
            // Check if user has already selected an option
            checkExistingDataScienceOption();
        }

        // Helper function to render a course section
        function renderCourseSection(sectionKey, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = '';
            
            // Create a row for course cards
            const row = document.createElement('div');
            row.className = 'row g-3';
            container.appendChild(row);
            
            const courses = courseGroups[sectionKey] || [];
            courses.forEach(course => {
                const currentGrade = courseData.courses[course.id]?.grade || '';
                
                // Create a column for each course
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4';
                
                // Create card for course
                const courseElement = document.createElement('div');
                courseElement.className = 'course-card';
                courseElement.setAttribute('data-course-id', course.id);
                courseElement.innerHTML = `
                    <div class="course-code">${course.id.toUpperCase()}</div>
                    <div class="course-title">${course.name}</div>
                    <div class="credits-display">${course.credits} credits</div>
                    <div class="grade-buttons">
                        <button type="button" class="grade-btn ${currentGrade === 'S' ? 'active' : ''}" 
                            data-grade="S" onclick="handleGradeChange('${course.id}', 'S')" 
                            ${sectionKey.includes('option') && !isOptionEnabled(sectionKey) ? 'disabled' : ''}>S</button>
                        <button type="button" class="grade-btn ${currentGrade === 'A' ? 'active' : ''}" 
                            data-grade="A" onclick="handleGradeChange('${course.id}', 'A')"
                            ${sectionKey.includes('option') && !isOptionEnabled(sectionKey) ? 'disabled' : ''}>A</button>
                        <button type="button" class="grade-btn ${currentGrade === 'B' ? 'active' : ''}" 
                            data-grade="B" onclick="handleGradeChange('${course.id}', 'B')"
                            ${sectionKey.includes('option') && !isOptionEnabled(sectionKey) ? 'disabled' : ''}>B</button>
                        <button type="button" class="grade-btn ${currentGrade === 'C' ? 'active' : ''}" 
                            data-grade="C" onclick="handleGradeChange('${course.id}', 'C')"
                            ${sectionKey.includes('option') && !isOptionEnabled(sectionKey) ? 'disabled' : ''}>C</button>
                        <button type="button" class="grade-btn ${currentGrade === 'D' ? 'active' : ''}" 
                            data-grade="D" onclick="handleGradeChange('${course.id}', 'D')"
                            ${sectionKey.includes('option') && !isOptionEnabled(sectionKey) ? 'disabled' : ''}>D</button>
                        <button type="button" class="grade-btn ${currentGrade === 'E' ? 'active' : ''}" 
                            data-grade="E" onclick="handleGradeChange('${course.id}', 'E')"
                            ${sectionKey.includes('option') && !isOptionEnabled(sectionKey) ? 'disabled' : ''}>E</button>
                    </div>
                `;
                
                col.appendChild(courseElement);
                row.appendChild(col);
            });
        }

        // Check if a Data Science option is enabled
        function isOptionEnabled(sectionKey) {
            if (sectionKey === 'dataScience_option1') {
                return selectedDataScienceOption === 'option1';
            } else if (sectionKey === 'dataScience_option2') {
                return selectedDataScienceOption === 'option2';
            }
            return true;
        }

        // Select Data Science option
        function selectDataScienceOption(optionKey) {
            // Clear grades from the other option first
            if (selectedDataScienceOption && selectedDataScienceOption !== optionKey) {
                clearOptionGrades(selectedDataScienceOption);
            }
            
            selectedDataScienceOption = optionKey;
            
            // Update UI
            document.querySelectorAll('.option-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById(`${optionKey}-card`).classList.add('selected');
            document.getElementById(`${optionKey}-radio`).checked = true;
            
            // Re-render to enable/disable grade selects
            renderCourses();
        }

        // Clear grades from an option
        function clearOptionGrades(optionKey) {
            const optionCourses = optionKey === 'option1' ? 
                courseGroups.dataScience_option1 : 
                courseGroups.dataScience_option2;
                
            optionCourses.forEach(course => {
                if (courseData.courses[course.id]) {
                    delete courseData.courses[course.id];
                }
            });
            
            // Auto-save the changes
            autoSaveData();
        }

        // Check existing Data Science option based on saved grades
        function checkExistingDataScienceOption() {
            const option1Courses = courseGroups.dataScience_option1 || [];
            const option2Courses = courseGroups.dataScience_option2 || [];
            
            const hasOption1Grades = option1Courses.some(course => courseData.courses[course.id]?.grade);
            const hasOption2Grades = option2Courses.some(course => courseData.courses[course.id]?.grade);
            
            if (hasOption1Grades && !hasOption2Grades) {
                selectDataScienceOption('option1');
            } else if (hasOption2Grades && !hasOption1Grades) {
                selectDataScienceOption('option2');
            }
        }

        // Handle grade change event
        async function handleGradeChange(courseId, grade) {
            try {
                // Check if this is an option course and enforce selection rules
                if (isOptionCourse(courseId) && grade && !selectedDataScienceOption) {
                    // Auto-select the appropriate option
                    if (isOption1Course(courseId)) {
                        selectDataScienceOption('option1');
                    } else if (isOption2Course(courseId)) {
                        selectDataScienceOption('option2');
                    }
                }
                
                // Check if trying to select from wrong option
                if (isOptionCourse(courseId) && grade && selectedDataScienceOption) {
                    if ((isOption1Course(courseId) && selectedDataScienceOption !== 'option1') ||
                        (isOption2Course(courseId) && selectedDataScienceOption !== 'option2')) {
                        alert('You can only select courses from one option. Please clear the other option first.');
                        return;
                    }
                }
                
                await updateGrade(courseId, grade);
            } catch (error) {
                console.error('Error updating grade:', error);
                showSaveStatus('Error saving grade', false);
            }
        }

        // Helper functions to check course types
        function isOptionCourse(courseId) {
            return isOption1Course(courseId) || isOption2Course(courseId);
        }

        function isOption1Course(courseId) {
            const option1Courses = courseGroups.dataScience_option1 || [];
            return option1Courses.some(course => course.id === courseId);
        }

        function isOption2Course(courseId) {
            const option2Courses = courseGroups.dataScience_option2 || [];
            return option2Courses.some(course => course.id === courseId);
        }

        // Update grade
        async function updateGrade(courseId, grade) {
            if (!courseData.courses) {
                courseData.courses = {};
            }

            const previousGrade = courseData.courses[courseId]?.grade;

            if (grade) {
                // If clicking the same grade that's already active, clear it
                if (previousGrade === grade) {
                    delete courseData.courses[courseId];
                    grade = null;
                } else {
                    courseData.courses[courseId] = {
                        grade: grade,
                        courseName: allCourses[courseId].name
                    };
                }
            } else {
                delete courseData.courses[courseId];
            }

            // Update button styling - find all grade buttons for this course
            const courseCard = document.querySelector(`[data-course-id="${courseId}"]`);
            if (courseCard) {
                // Remove active class from all buttons
                const buttons = courseCard.querySelectorAll('.grade-btn');
                buttons.forEach(btn => btn.classList.remove('active'));
                
                // Add active class to selected grade button
                if (grade) {
                    const activeButton = courseCard.querySelector(`.grade-btn[data-grade="${grade}"]`);
                    if (activeButton) {
                        activeButton.classList.add('active');
                    }
                }
            }

            // Recalculate stats
            recalculateStats();
            
            // Auto-save data
            await autoSaveData();
        }

        // Recalculate statistics
        function recalculateStats() {
            const gradePoints = { S: 10, A: 9, B: 8, C: 7, D: 6, E: 4 };
            let totalPoints = 0;
            let totalCredits = 0;
            let completedCourses = 0;
            const gradeDistribution = { S: 0, A: 0, B: 0, C: 0, D: 0, E: 0 };

            Object.entries(courseData.courses).forEach(([courseId, courseInfo]) => {
                if (courseInfo.grade && gradePoints[courseInfo.grade]) {
                    const credits = allCourses[courseId].credits;
                    totalPoints += gradePoints[courseInfo.grade] * credits;
                    totalCredits += credits;
                    completedCourses++;
                    gradeDistribution[courseInfo.grade]++;
                }
            });

            const cgpa = totalCredits > 0 ? totalPoints / totalCredits : 0;

        userData.stats = {
            cgpa: parseFloat(cgpa.toFixed(3)),
            totalCredits,
            completedCourses,
            gradeDistribution,
            totalPoints
        };            updateDashboard();
        }

        // Show save status
        function showSaveStatus(message, isSuccess = true) {
            // Remove existing status if any
            const existingStatus = document.getElementById('save-status');
            if (existingStatus) {
                existingStatus.remove();
            }

            // Create status element
            const statusDiv = document.createElement('div');
            statusDiv.id = 'save-status';
            statusDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${isSuccess ? '#28a745' : '#dc3545'};
                color: white;
                padding: 10px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1050;
                font-size: 14px;
                transition: all 0.3s ease;
            `;
            statusDiv.textContent = message;

            document.body.appendChild(statusDiv);

            // Auto-remove after 2 seconds
            setTimeout(() => {
                if (statusDiv) {
                    statusDiv.style.opacity = '0';
                    setTimeout(() => {
                        if (statusDiv && statusDiv.parentNode) {
                            statusDiv.parentNode.removeChild(statusDiv);
                        }
                    }, 300);
                }
            }, 2000);
        }

        // Auto-save data (with subtle feedback)
        async function autoSaveData() {
            const token = checkAuth();
            if (!token) return;

            try {
                console.log('DEBUG: Starting auto-save...');
                const response = await fetch(`${API_BASE}/user/data`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        course_data: courseData,
                        target_cgpa: userData.target_cgpa
                    })
                });

                console.log('DEBUG: Auto-save response status:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('DEBUG: Auto-save successful');
                    showSaveStatus('âœ“ Grade saved automatically', true);
                } else {
                    if (response.status === 401 || response.status === 422) {
                        console.log('DEBUG: Authentication failed during auto-save');
                        localStorage.removeItem('access_token');
                        localStorage.removeItem('user');
                        window.location.href = '/';
                        return;
                    }
                    const errorData = await response.json();
                    console.error('Auto-save failed:', errorData.message);
                    showSaveStatus('Failed to save grade', false);
                }
            } catch (error) {
                console.error('Auto-save error:', error);
                showSaveStatus('Failed to save grade', false);
            }
        }

        // Save data
        async function saveData() {
            const token = checkAuth();
            if (!token) return;

            const saveBtn = document.querySelector('.btn-save');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
            saveBtn.disabled = true;

            try {
                const response = await fetch(`${API_BASE}/user/data`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        course_data: courseData,
                        target_cgpa: userData.target_cgpa
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Show success message
                    saveBtn.innerHTML = '<i class="fas fa-check me-2"></i>Saved!';
                    saveBtn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                    
                    setTimeout(() => {
                        saveBtn.innerHTML = originalText;
                        saveBtn.style.background = '';
                        saveBtn.disabled = false;
                    }, 2000);

                } else {
                    throw new Error(data.message || 'Save failed');
                }
            } catch (error) {
                console.error('Error saving data:', error);
                alert('Failed to save data. Please try again.');
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }

        // Dark mode functionality
        function toggleDarkMode() {
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');
            
            body.classList.toggle('dark-mode');
            
            if (body.classList.contains('dark-mode')) {
                themeIcon.className = 'fas fa-sun';
                themeText.textContent = 'Light';
                localStorage.setItem('darkMode', 'enabled');
            } else {
                themeIcon.className = 'fas fa-moon';
                themeText.textContent = 'Dark';
                localStorage.setItem('darkMode', 'disabled');
            }
        }

        function loadDarkMode() {
            const darkMode = localStorage.getItem('darkMode');
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');
            
            if (darkMode === 'enabled') {
                body.classList.add('dark-mode');
                themeIcon.className = 'fas fa-sun';
                themeText.textContent = 'Light';
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDarkMode();
            loadUserData();
        });
    </script>
</body>
</html>
